# Generated by CoffeeScript 1.4.0

window.calendar_url = 'http://events.cornell.edu'
window.users_created_chart = null

# define slzr/reports/users_created_by_day module
modulejs.define 'slzr/reports/users_created_by_day', ['jquery', 'underscore'], ($, _) ->

  # initialize the data for drawing chart
  chartData =
    labels: []
    datasets: [ {
      label: 'Users Created By Day'
      fillColor: 'rgba(151,187,205,0.2)'
      strokeColor: 'rgba(151,187,205,1)'
      pointColor: 'rgba(151,187,205,1)'
      pointStrokeColor: '#fff'
      pointHighlightFill: '#fff'
      pointHighlightStroke: 'rgba(151,187,205,1)'
      data: []
    } ]

  # initialize users created by day
  eventsCreatedByDay = null

  # define method to get users created by day
  getEventsCreated: ->
    dateRange = $('#date_range_select').val()
    endDate = new Date
    startDate = new Date
    showChartWeekly = false

    # set start date and end date for reporting
    if dateRange != 'Custom'
      startDate.setDate startDate.getDate() - parseInt(dateRange) + 1
    else
      startDate = $("#start_date_input").data("date")
      endDate = $("#end_date_input").data("date")

    # check if showing chart daily or weekly
    if (endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24) > 14
      showChartWeekly = true

    $.ajax
      url: window.calendar_url + '/api/2/users/stats/created'
      type: 'GET'
      data: 'start=' + startDate.toISOString().slice(0, 10) + '&end=' + endDate.toISOString().slice(0, 10)
      cache: false
      async: false
      dataType: 'json'
      success: (data, textStatus, jqXHR) ->
        eventsCreatedByDay = data

    chartData.datasets[0].data = []
    chartData.labels = []

    if eventsCreatedByDay != null
      weekStartDate = ""
      weekCount = 0
      $(eventsCreatedByDay.created).each (index, element) ->
        if showChartWeekly == false
          chartData.datasets[0].data.push element.count
          chartData.labels.push moment(element.date, "YYYY-MM-DD[T]hh:mm:ss").format("MMM DD, YYYY")
        else
          if index % 7 == 0
            weekStartDate = moment(element.date, "YYYY-MM-DD[T]hh:mm:ss").format("MMM DD, YYYY")
          if index % 7 == 6 || index == eventsCreatedByDay.created.length - 1
            chartData.datasets[0].data.push weekCount += element.count
            chartData.labels.push weekStartDate += " ~ " + moment(element.date, "YYYY-MM-DD[T]hh:mm:ss").format("MMM DD, YYYY")
          weekCount += element.count

  # method to draw chart
  drawChart: ->
    if window.users_created_chart != null
      window.users_created_chart.destroy()
    ctx = document.getElementById('canvas').getContext('2d')
    window.users_created_chart = new Chart(ctx).Line(chartData, responsive: true)

  # method to show report
  showDataOnReport: ->
    reportBody = ''
    $(eventsCreatedByDay.created).each (index, element) ->
      reportBody += '<tr>'
      reportBody += '<td>' + moment(element.date, "YYYY-MM-DD[T]hh:mm:ss").format("MMM DD, YYYY") + '</td>'
      reportBody += '<td>' + element.count + '</td>'
      reportBody += '</tr>'

    $('.item-list tbody').html reportBody

Slzr.jQuery ($) ->

  return unless $(document.body).is('.admin-analytics-users-created')

  $('#custom_date_range').hide()

  UsersCreatedModule = modulejs.require('slzr/reports/users_created_by_day')
  UsersCreatedModule.getEventsCreated()
  UsersCreatedModule.drawChart()
  UsersCreatedModule.showDataOnReport()

  # action triggered when changing date range
  $(document).onAction 'change-date-range', (event) ->
    if $(this).val() == 'Custom'
      $('#custom_date_range').show()
    else
      $('#custom_date_range').hide()

  # action triggered when clicking 'update' button
  $(document).onAction 'update-report', (event) ->
    if $("#date_range_select").val() == "Custom" && ($("#start_date_input").data("date-status") != "ok" && $("#end_date_input").data("date-status") != "ok")
      # show notice
    else
      UsersCreatedModule.getEventsCreated()
      UsersCreatedModule.drawChart()
      UsersCreatedModule.showDataOnReport()
